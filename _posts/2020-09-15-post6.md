---
layout: post
title: (NGINX) HTTP Header 관련 http module directive 분석
category: network
---
# 목차
  * [개요](#개요)
  * [본문](#본문)
    * [1. HTTP Request Header](#http_request_header)
    * [2. NGINX HTTP header 관련 지시어 (Directives)](#http_request_header_directive)
      * [ignore_invalid_headers](#ignore_invalid_headers)
      * [underscores_in_headers](#underscores_in_headers)
    * [3. NGINX 에서 HTTP Header 관련 동작](#nginx_http_header_process)
      * [HTTP Header Field Invalid 판단 조건](#nginx_http_header_valid_check)
      * [Predefined HTTP Header](#nginx_predefined_http_header)
      * [HTTP header variable](#nginx_http_header_variable)
      * [HTTP Header 관련 지시어에 의한 동작 FLOW](#http_header_flow)
    * [4. 지시어 적용시 발생할 수 있는 영향도](#side_effect)
  * [참고](#참고)

## 개요

* NGINX 가 Proxy 역활을 수행 할 때, 데몬에 유효하지 않은 (eg. underscore) 헤더가 포함된 HTTP 요청 또는 응답이 전달되었을 때,
해당 헤더는 필터링 되어 목적지 까지 전달되지 않을 수 도 있습니다.

> 참고: NGINX 에서는 기본 옵션으로 underscore가 포함된 헤더를 허용하지 않습니다.

* 위 사항에 대해 해결할 수 있는 NGINX 관련 설정, 설정시 발생할 수 있는 영향도에 대해 정리를 진행 합니다.

---

## 본문

* 시작하기 앞서, HTTP Header 가 어떤 형태로 올 수 있는지 알아야 합니다.

### 1. HTTP Request Header {#http_request_header}

> 참고:  HTTP Header는 HTTP Protocol 을 통해 요청 또는 응답 정보를 목적지로 전송할 때, 추가적인 정보(동작)을 정의하기 위해 사용 합니다.

* HTTP Header 항목은 General Header, Request Header, Entity Header 등의 미리 정의된 헤더도 있지만
사용자가 임의로 정의 하여 사용할 수도 있습니다.
  > 참고: [General Header](https://tools.ietf.org/html/rfc2616#section-4.5), [Request Header](https://tools.ietf.org/html/rfc2616#section-5.3), [Entity Header](https://tools.ietf.org/html/rfc2616#section-7.1)

* 사용자 정의 헤더 는 일반적으로 'X-' 를 앞에 붙여 명시 했지만, 현재는 꼭 붙여주지 않아도 됩니다.

  * eg.
    ```
      X-Forwarded-For, X-Forwarded-Host, X-Forwarded-Proto
    ```
    > 참고 : [rfc2047](https://www.ietf.org/rfc/rfc2047.txt)

* 이러한 헤더는 'Header-name:Header-value' 로 정의할 수 있으며, 각 name, value 값은 아래의 포맷에 맞게 정의 되어야 합니다.
  * HTTP Header Format

    ```
      header-field   = field-name ":" OWS field-value OWS

      field-name     = token
      field-value    = *( field-content / obs-fold )
      field-content  = field-vchar [ 1*( SP / HTAB ) field-vchar ]
      field-vchar    = VCHAR / obs-text

      obs-fold       = CRLF 1*( SP / HTAB )
                       ; obsolete line folding
                       ; see Section 3.2.4
    ```

    * OWS : optional whitespace
    * SP : Space
    * HTAB : Horizontal tab
    * VCHAR : ASCII standard set (Any visible character)
    * obs-text(obsolete-text) : ASCII extended set(%x80-FF)
    * token : 1개 이상의 알파벳 또는 숫자(0-9) 또는 특수 문자 ``` ! # $ % & ' * + - . ^ _ ` | ~ ```

    > 참고 : [rfc7230](https://tools.ietf.org/html/rfc2047#page-7)


### 2. NGINX HTTP header 관련 지시어 (Directives) {#http_request_header_directive}

* NGINX 에서 HTTP Header에 대해 다룰 수 있는 관련 지시어는 아래와 같습니다.

#### [ignore_invalid_headers] {#ignore_invalid_headers}

* 구조

  ```
    Syntax: ignore_invalid_headers on | off;
    Default: ignore_invalid_headers on;
    Context: http, server
  ```
* 설명
  * 유효하지 않은 HTTP 헤더에 대한 허용 여부를 판단 해줍니다.
* 동작
  * 'on' (기본 값): 헤더가 유효하지 않을 때, 아래의 로그를 출력하며 해당 헤더에 대한 처리는 진행 하지 않습니다.
    ```
      client sent invalid header line <Header field>
    ```
  * 'off': 유효하지 않은 헤더에 대해서 무시하지 않고, 처리를 진행 합니다.

#### [underscores_in_headers] {#underscores_in_headers}

* 구조
  ```
    Syntax: underscores_in_headers on | off;
    Default: underscores_in_headers off;
    Context: http, server
  ```
* 설명
  * HTTP 헤드 필드에 underscore('_')가 포함되었을 경우, 해당 헤더에 대한 허용 여부를 판단 해줍니다.
* 동작
  * 'off' (기본 값): 헤더 필드에 underscore가 포함되어 있는 경우, 해당 헤더는 유효하지 않다고 판단
    * 이 후, 해당 헤더는 <b>[ignore_invalid_headers](#ignore_invalid_headers)</b> 지시어에 의해 처리 됩니다.
  * 'on': 헤더 필드에 underscore가 포함되어 있어도, 해당 헤더는 유효 하다고 판단합니다.

### 3. NGINX 에서 HTTP Header 관련 동작 {#nginx_http_header_process}

#### [HTTP Header Field Invalid 판단 조건] {#nginx_http_header_valid_check}

* NGINX는 전달 받은 HTTP 요청 또는 응답의 모든 Header Field에 대해 파싱을 진행하면서, 해당 헤더에 대한 유효성 검사를 수행 합니다.
  * 파싱 진행은 'nginx/src/http/ngx_http_parse.c' 에 정의된 ngx_http_parse_header_line() 함수에 의해 진행 됩니다.
<br>
* 유효성 검사 방식
  * Header Field를 한 문자 씩 분리한 값 (이하 'ch')과
  * 위 값 ('ch')를 아래 조건에 맞게 필터링 된 값 (이하 'c'), 두개를 사용하여 유효성 검사를 진행 합니다
    * 필터링 조건

      ```
        1. hyphen('-') 인 경우 그대로 사용
        2. 0 ~ 9 인 경우 그대로 사용
        3. 알파벳인 경우 소문자로 변환
        4. 이 외 경우 'NULL' 문자로 변환
      ```

    * 참고 Code

      ```
        for (p = b->pos; p < b->last; p++) {  // <- b(buffer)에 heade field 정보가 있음
        ch = *p;  // <- 한 문자씩 분리

        switch (state) {

        /* first char */
        case sw_start:
            r->header_name_start = p;
            r->invalid_header = 0;

            switch (ch) {
                // ... 중략 (파싱 수행)

                c = lowcase[ch];   // 위 필터링 조건에 의해 변환

                // ... 중략 (파싱 수행)
        ```

* 유효성 검사 조건
  * 헤더 필드를 구분하여 진행 합니다.
    * Header-Name (첫 글자)
      1. (Valid) 'c' 가 'NULL' 이 아닐 때
      2. (Valid) 'ch' 가 'underscore(_)' 이면서, underscores_in_headers 지시어 설정이 'on' 일 때
      3. (Invalid) 이 외 경우
    * Header-Name (첫 글자 이후 ':' 까지)
      1. (Valid) 'c' 가 'NULL' 이 아닐 때
      2. (Valid) 'ch' 가 'underscore(_)' 이면서, underscores_in_headers 지시어 설정이 'on' 일 때
      3. (Valid) 'ch' 가 'Slash(/)' 일 때
          * IIS 는 'HTTP/1.1 ..' 과 같은 라인을 중복으로 보낼 수 있기 때문에, 위 값을 만나면 해당 Line은 통째로 무시함
      4. (Valid) 'ch' 가 'Colon(:)' 일 때
          * 이 후, Header-Value에 대한 파싱을 진행 합니다.
      5. (Valid) 'ch' 가 'CR (Carriage Return)' 일 때
          * 이 후, 파싱을 종료 합니다. (Header-Value는 없음)
      6. (Valid) 'ch' 가 'LF (Line Feed)' 일 때
          *이 후, 파싱을 종료 합니다. (Header-Value는 없음)
      7. (Invalid) 이 외 경우
    * Header-Value
      1. (Valid) 'ch' 가 'NULL'이 아닌 경우
      2. (Invalid) 이 외 경우

#### [Predefined HTTP Header] {#nginx_predefined_http_header}

* NGINX는 전달 받은 HTTP 요청 또는 응답에 대한 헤더가 유효한 경우 , 지정된 Handler를 통해 특정 작업을 수행 합니다.

  >  참고 : [Invalid Header 판단 조건](#nginx_http_header_valid_check)

* 위 Handler 정보는 'nginx/src/http/ngx_http_request.c' 의 ngx_http_header_in 리스트에 Predefined 되어 있습니다.
  * Predefined된 헤더 정보는 아래와 같습니다.

      | 헤더 |	핸들러 |
      |:--:|:--:|
      | Hos	| ngx_http_process_host |
      | Connection	| ngx_http_process_connection |
      | If-Modified-Since |	ngx_http_process_unique_header_line |
      | If-Unmodified-Since |	ngx_http_process_unique_header_line |
      | If-Match |	ngx_http_process_unique_header_line |
      | If-None-Match |	ngx_http_process_unique_header_line |
      | User-Agent |	ngx_http_process_user_agent |
      | Referer	| ngx_http_process_header_line |
      | Content-Length	| ngx_http_process_unique_header_line |
      | Content-Range	| ngx_http_process_unique_header_line |
      | Content-Type	| ngx_http_process_header_line |
      | Range	| ngx_http_process_header_line |
      | If-Range	| ngx_http_process_unique_header_line |
      | Transfer-Encoding	| ngx_http_process_header_line |
      | Expect	| ngx_http_process_unique_header_line |
      | Upgrade	| ngx_http_process_header_line |
      | Accept-Encoding	| ngx_http_process_header_line |
      | Via	| ngx_http_process_header_line |
      | Authorization	| ngx_http_process_unique_header_line |
      | Keep-Alive	| ngx_http_process_header_line |
      | X-Forwarded-For	| ngx_http_process_multi_header_lines |
      | X-Real-IP	| ngx_http_process_header_line |
      | Accept	| ngx_http_process_header_line |
      | Accept-Language	| ngx_http_process_header_line |
      | Depth	| ngx_http_process_header_line |
      | Destination	| ngx_http_process_header_line |
      | Overwrite	| ngx_http_process_header_line |
      | Date	| ngx_http_process_header_line |
      | Cookie	| ngx_http_process_multi_header_lines |

* Predefined이 되지 않은 헤더(Handler 정보가 없는 헤더) 에 대해서는, 특정 작업 처리 없이 다음 동작이 진행됩니다.

#### [HTTP header variable] {#nginx_http_header_variable}

* NGINX 에서는 HTTP Header Field에 포함된 값을 nginx conf에서 사용할 수 있도록 variable한 값으로 자동 변환 해줍니다.

  ```
  $http_<name of the header-name>
  ```

  * eg. 헤더 필드에 'test-header = test.com' 가 포함된 경우
    * '$http_test_header 를 사용하여 'test.com' 이라는 header-value를 얻을 수 있습니다.

  > 참고 : [nginx-http-core-module](http://nginx.org/en/docs/http/ngx_http_core_module.html#var_http_)

#### [HTTP Header 관련 지시어에 의한 동작 FLOW] {#http_header_flow}

* 정리 중

### 4. 지시어 적용시 발생할 수 있는 영향도 {#side_effect}

* 정리 중

---

## 참고

* NGINX 관련
  * http://nginx.org/en/docs/http/ngx_http_core_module.html
* HTTP 관련
  * https://tools.ietf.org/html/rfc7230
  * https://tools.ietf.org/html/rfc2616
  * https://tools.ietf.org/html/rfc2047
* ABNF
  * https://tools.ietf.org/html/rfc5234
* ASCII
  * http://lwp.interglacial.com/appf_01.htm
  * http://www.asciitable.com/
